<!doctype html>
<html>
    <head>
        <style>
            html,
            body {
                margin: 0;
                padding: 0;
                background: transparent !important;
                /* Critical for transparency */
                height: 100%;
                overflow: hidden;
                font-family: sans-serif;
            }

            /* The actual visible window container */
            .container {
                background-color: rgba(0, 0, 0, 0.85);
                color: white;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                /* Center content vertically */
                gap: 10px;
                /* Space between rows */
                height: 100%;
                border-radius: 30px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                box-sizing: border-box;
                padding: 15px 20px;
                /* Reduced vertical padding */
                -webkit-app-region: drag;
            }

            /* Top Row: Logo, Waveform, Mic */
            .top-row {
                position: absolute;
                top: 15px;
                display: flex;
                align-items: center;
                /*justify-content: space-between;*/
                gap: 20px;
                /*width: 100%;*/
                height: 40px;
                /* Slightly smaller */
            }

            .logo {
                width: 32px;
                /* Smaller logo */
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
            }

            .logo img {
                width: 100%;
                height: 100%;
                object-fit: contain;
            }

            .waveform {
                flex-grow: 1;
                height: 30px;
                /* Smaller waveform */
                margin: 0 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 3px;
            }

            .bar {
                width: 3px;
                /* Thinner bars */
                background-color: rgba(255, 255, 255, 0.8);
                border-radius: 2px;
                height: 4px;
                transition: height 0.05s ease;
            }

            .mic-btn {
                background: none;
                border: none;
                cursor: pointer;
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                transition:
                    transform 0.1s,
                    color 0.2s;
                -webkit-app-region: no-drag;
                width: 32px;
                /* Smaller mic button */
                height: 32px;
                padding-top: 7px;
            }

            .mic-btn:hover {
                transform: scale(1.1);
                color: #d8b4fe;
            }

            .mic-icon svg {
                width: 28px;
                height: 28px;
                fill: currentColor;
            }

            /* Bottom Row: Stop Button */
            .bottom-row {
                position: absolute;
                bottom: 10px;
                display: flex;
                justify-content: center;
                width: 100%;
                height: 15px;
            }

            .stop-btn {
                background-color: white;
                color: black;
                border-radius: 20px;
                padding: 6px 20px;
                /* Smaller padding */
                font-weight: 600;
                font-size: 12px;
                /* Smaller font */
                display: flex;
                align-items: center;
                gap: 6px;
                border: none;
                cursor: pointer;
                transition:
                    transform 0.1s,
                    background-color 0.2s;
                -webkit-app-region: no-drag;
            }

            .stop-btn:hover {
                transform: scale(1.05);
                background-color: #f0f0f0;
            }

            .stop-icon {
                width: 10px;
                height: 10px;
                background-color: darkred;
                border-radius: 2px;
            }

            /* Muted state */
            .mic-btn.muted {
                color: #ef4444;
            }
        </style>
    </head>

    <body>
        <div class="container">
            <div class="top-row">
                <div class="logo">
                    <img src="obsidian_logo.png" alt="Obsidian Logo" />
                </div>

                <div class="waveform" id="waveform">
                    <!-- Bars will be generated by JS -->
                </div>

                <button class="mic-btn" id="micBtn" title="Toggle Microphone">
                    <div class="mic-icon">
                        <!-- Mic Icon -->
                        <svg viewBox="0 0 24 24">
                            <path
                                d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"
                            />
                            <path
                                d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"
                            />
                        </svg>
                    </div>
                </button>
            </div>

            <div class="bottom-row">
                <button class="stop-btn" id="stopBtn">
                    <div class="stop-icon"></div>
                    Stop Recording
                </button>
            </div>
        </div>

        <script>
            const { ipcRenderer } = require("electron");

            const micBtn = document.getElementById("micBtn");
            const stopBtn = document.getElementById("stopBtn");
            const waveform = document.getElementById("waveform");

            // Generate waveform bars
            const barCount = 20;
            const bars = [];
            for (let i = 0; i < barCount; i++) {
                const bar = document.createElement("div");
                bar.className = "bar";
                waveform.appendChild(bar);
                bars.push(bar);
            }

            let isMuted = false;

            micBtn.addEventListener("click", () => {
                isMuted = !isMuted;
                micBtn.classList.toggle("muted", isMuted);

                if (isMuted) {
                    ipcRenderer.send("mute-mic");
                    micBtn.innerHTML = `
                <div class="mic-icon">
                    <svg viewBox="0 0 24 24">
                        <path d="M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28zm-4.02.17c0-.06.02-.11.02-.17V5c0-1.66-1.34-3-3-3S9 3.34 9 5v.18l5.98 5.99zM4.27 3L3 4.27l6.01 6.01V11c0 2.76 2.24 5 5 5 .52 0 1.03-.08 1.5-.21L19.73 20 21 18.73 4.27 3zM12 19c-2.76 0-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2c0 2.76-2.24 5-5 5z"/>
                    </svg>
                </div>`;
                } else {
                    ipcRenderer.send("unmute-mic");
                    micBtn.innerHTML = `
                <div class="mic-icon">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                    </svg>
                </div>`;
                }
            });

            stopBtn.addEventListener("click", () => {
                ipcRenderer.send("stop-recording");
            });

            // Listen for audio levels to animate waveform
            ipcRenderer.on("audio-level", (event, level) => {
                bars.forEach((bar, index) => {
                    const visualLevel = Math.pow(level, 0.5);
                    const noise = Math.random() * 0.3;
                    let height = Math.max(4, (visualLevel + noise) * 35);
                    height = Math.min(height, 35);
                    bar.style.height = `${height}px`;
                    bar.style.opacity = 0.6 + visualLevel * 0.4;
                });
            });

            ipcRenderer.on("set-logo", (event, path) => {
                const img = document.querySelector(".logo img");
                if (img) img.src = path;
            });
        </script>
    </body>
</html>
